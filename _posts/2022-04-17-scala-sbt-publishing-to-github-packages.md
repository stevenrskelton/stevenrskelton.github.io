---
title: "Scala (SBT) Publishing to Github Packages"
categories:
- Platform
- Scala
---
Github Packages is the natural extension to a Github Action CI/CD pipeline fulfilling the need for storage of released compiled code artifacts.
It currently offers repositories for Java (Maven), .Net (NuGet), Ruby (Gems), Javascript (npm), and Docker images.  The great benefit here is that this
service is free (with a size limitation caveat) and uses OAuth keys managed in Github.

Since Scala is a JVM language the developers of SBT have implemented artifact publishing to Maven using the `sbt publish` task.  Github Actions have a few
special rules, but it it should be straight forward to set things up.

## HTTP 422 Errors

There are a few step-by-step walk-throughs to configure the SBT plugin [sbt-github-packages](https://github.com/djspiewak/sbt-github-packages) however I couldn't get it to work, either locally or in Github Actions.
```
[error] java.io.IOException: Error writing to server
[error] 	at java.base/sun.net.www.protocol.http.HttpURLConnection.writeRequests(HttpURLConnection.java:718)
[error] 	at java.base/sun.net.www.protocol.http.HttpURLConnection.writeRequests(HttpURLConnection.java:730)
[error] 	at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1613)
[error] 	at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1520)
[error] 	at java.base/java.net.HttpURLConnection.getResponseCode(HttpURLConnection.java:527)
[error] 	at java.base/sun.net.www.protocol.https.HttpsURLConnectionImpl.getResponseCode(HttpsURLConnectionImpl.java:334)
[error] 	at org.apache.ivy.util.url.BasicURLHandler.upload(BasicURLHandler.java:284)
[error] 	at org.apache.ivy.util.url.URLHandlerDispatcher.upload(URLHandlerDispatcher.java:82)
```

For an activily maintained Github project, I was sad to see an identical 4 month old open issue
[Without change the SBT file, I get a "java.io.IOException: Error writing to server" exception](https://github.com/djspiewak/sbt-github-packages/issues/48).
Grinding through the web, there could be a lot of causes, some client side. Maybe my project name is wrong somehow, or the version numbers aren't set, etc.

## Über Jar

To complicate the issue further, I didn't just want to privately publish my standard artifacts, I want to publish an über jar.
What makes these difference are they include their dependencies in the jar, so not just your compiled code but all of the compiled code for the external libraries as well.
(more discussion on [Stack Overflow](https://stackoverflow.com/questions/11947037/what-is-an-uber-jar)). It normally doesn't make sense to publish these because it makes it almost impossible to use this jar in another project.
But people do it because it makes the jar a standalone executable.

There is an SBT plugin called [sbt/sbt-assembly](https://github.com/sbt/sbt-assembly) that handles this.

So with the Maven package publishing already not working, and now additional requirements to publish non-standard artifacts it looks like trouble ahead.

## SBT is Scala, and Maven is Already Supported

Sometimes its smart to not over complicate things. We have 2 tasks, compile and publish.
It looks like sbt-assembly compiles fine, but nothing in SBT wants to publish.  
I'm not going to change my Scala project to compile with Maven, but its safe to assume Maven publishing works.  Looking over the Maven documentation
 there appears to be a [deploy:deploy-file](https://maven.apache.org/plugins/maven-deploy-plugin/deploy-file-mojo.html) command to publish any file.

The command for this will be something like:
```shell
mvn deploy:deploy-file 
        -Durl=https://maven.pkg.github.com/user/repo \
        -DrepositoryId=github \
        -Dfile=target/scala-2.13/project_2.13-version-number.jar \
        -DgroupId=com.yourcompany -DartifactId=project -Dversion=version-number
```
There is an implicit file, the parameter `repositoryId=github` refers to your `~/.m2/settings.xml` which will securely store your repository credentials.
A way to work around this is to use `--settings=settings.xml` which will tell `mvn` to look for the file in your current directory instead.

_Sidenote: since we are creating an über jar, the artifact generated by `sbt-assembly` is named `project-assembly` instead of `project`_

## Creating a custom SBT task

SBT is a Scala program which uses the scalac compiler to compile other Scala code. So all SBT plugins and customizations are just more Scala code, 
although `.sbt` files have a few restrictions.

We want to create a new task, such that when we type in `sbt publishGithub` it will publish to Github.
```scala
lazy val publishAssembyToGithubPackages = taskKey[Unit]("Publish Über Jar to Github Packages")
publishAssembyToGithubPackages := {
  ...your scala code goes here...
}
```
Next is to assign its body.  We don't care about different contexts, everything we will do will be in the Global scope.  We also don't especially care
about having this run locally or outside of Github Actions, but Github Actions is built around environmental variables.

There are only a few things that are external to the project codebase, they are the Github owner `GITHUB_REPOSITORY_OWNER`, 
 Github repository `GITHUB_REPOSITORY` and the Github OAuth token `GITHUB_TOKEN`.  The names of all of these are in the 
[Github Action documentation](https://docs.github.com/en/actions/learn-github-actions/environment-variables#default-environment-variables).

To populate our `pubhlishGithub` task, first a few sanity checks if the ENV variables have been properly set:
```scala
val githubRepository = sys.env.get("GITHUB_REPOSITORY").getOrElse {
  throw new Exception("You must set environmental variable GITHUB_REPOSITORY, eg: owner/repository")
}
if(!sys.env.keySet.contains("GITHUB_REPOSITORY_OWNER")) { 
  throw new Exception("You must set environmental variable GITHUB_REPOSITORY_OWNER, eg: your username")
}
if(!sys.env.keySet.contains("GITHUB_TOKEN")) { 
  throw new Exception("You must set environmental variable GITHUB_TOKEN")
}
```
Next, we can construct the `mvn deploy:deploy-file` parameters, using the `name`, `version`, and `scalaVersion` keys defined in `build.sbt`:

And now finally executing a shell command - this will assume that `mvn` is installed.
```scala
val exe = s"""mvn deploy:deploy-file
  -Durl=https://maven.pkg.github.com/$githubRepository
  -DrepositoryId=github -Dfile=${assembly.value}
  -DgroupId=${organization.value}
  -DartifactId=${name.value}-assembly
  -Dversion=${version.value} --settings=target/settings.xml
""".stripLineEnd

println(s"Executing shell command $exe")
import scala.sys.process._
if(exe.! != 0) throw new Exception("publishAssembyToGithubPackages failed")
```
The only thing left is to setup a suitable `seetings.xml`. We could do this either by commiting one into our code or generating one inside 
 of a Github Action.  To keep things simple, we'lll use SBT's `IO.write` to write this XML out into the `target` folder to avoid clutter in our source code.
```xml
<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                      http://maven.apache.org/xsd/settings-1.0.0.xsd">

  <activeProfiles>
    <activeProfile>github</activeProfile>
  </activeProfiles>

  <profiles>
    <profile>
      <id>github</id>
      <repositories>
        <repository>
          <id>github</id>
          <url>https://maven.pkg.github.com/${GITHUB_REPOSITORY}</url>
          <snapshots>
            <enabled>true</enabled>
          </snapshots>
        </repository>
      </repositories>
    </profile>
  </profiles>

  <servers>
    <server>
      <id>github</id>
      <username>${GITHUB_REPOSITORY_OWNER}</username>
      <password>${GITHUB_TOKEN}</password>
    </server>
  </servers>
</settings>
```

## Github Workflow

With all of our `publishGithub` code added to `build.sbt` file, and our `settings.xml` commited, the only thing left to do is configure a new 
Github Action to call `sbt publish`

We are creating a new file `github/workflows/publish-uber-assembly-to-github.yml`.  

_Sidenote: It is possible you'll need to adjust your Personal Access Token permissions to check in this file, `workflow` permissions aren't assigned by default._

Start with the basics, a name
```yaml
name: Publish Über Assembly to Github Packages
```
Make it a manual execution for now, this could be tied into git tag events or however else you structure a releases:
```yaml
on:
  workflow_dispatch:
```
Speaking of permissions, the GITHUB_TOKEN for this action will need to be brought into ENV and assigned write permissions to packages:
```yaml
env:
  GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
  
permissions:
  contents: read
  packages: write
```
Creating a simple job, we want to run `sbt dist`, in my case I will call `sbt assembly` since I want an über jar.
Then follow up with `sbt publishGithub` to upload our artifact to Githb Packages Maven.
```yaml
jobs:
 build:

  runs-on: ubuntu-latest

  steps:
   - uses: actions/checkout@v3
   - name: Set up JDK 11
     uses: actions/setup-java@v3
     with:
      java-version: '11'
      distribution: 'temurin'
   - name: Publish Über Jar to Github Packages
     run: sbt publishAssembyToGithubPackages
```

The last step is to commit the code, and trigger the action in Github.

{%
include downloadsources.html
src="/assets/images/2022/04-16/publish-uber-assembly-to-github.yml, /assets/images/2022/04-16/publishAssembyToGithubPackages.sbt"
%}